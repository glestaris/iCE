#!/usr/bin/env python
import os
import ConfigParser
import logging
import ice
from ice import config
from ice.registry import server
from ice.registry.server import domain


def _get_config_factory():
    cfg = ConfigParser.SafeConfigParser()
    for dir_path in ice.CONFIG_DIRS:
        file_path = os.path.join(dir_path, "ice.ini")
        if os.path.isfile(file_path):
            cfg.read(file_path)
    return config.ConfigFactory(cfg)


def _get_logger():
    for dir_path in ice.CONFIG_DIRS:
        file_path = os.path.join(dir_path, "logging.ini")
        if os.path.isfile(file_path):
            logging.config.fileConfig(file_path)
    return logging.getLogger('ice.shell')


if __name__ == '__main__':
    logger = _get_logger()
    logger.setLevel(logging.DEBUG)

    server.RegistryServer(
        _get_config_factory().get_registry_server(),
        [
            domain.instances.InstancesDomain(),
            domain.sessions.SessionsDomain()
        ],
        logger
    ).run()
